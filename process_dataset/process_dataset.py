import dgl
import sys
import torch
import argparse
import traceback
import joblib as J
import networkx as nx
import multiprocessing

from pathlib import Path
from androguard.misc import AnalyzeAPK
from FeatureExtractors import FeatureExtractors, ATTRIBUTES
from pruning_graph import GraphPruning


def process(source_file: Path, dest_dir: Path):
    try:
        file_name = source_file.stem
        _, _, dx = AnalyzeAPK(source_file)
        cg = dx.get_call_graph()
        mappings = {}
        for node in cg.nodes():
            features = {
                "api": torch.zeros(FeatureExtractors.NUM_API_PACKAGES),
                "user": torch.zeros(FeatureExtractors.NUM_OPCODE_MAPPINGS)
            }
            if node.is_external():
                features["api"] = FeatureExtractors.get_api_features(node)
            else:
                features["user"] = FeatureExtractors.get_user_features(node)
            mappings[node] = features
        nx.set_node_attributes(cg, mappings)
        cg = nx.convert_node_labels_to_integers(cg)
        dg = dgl.from_networkx(cg, node_attrs=ATTRIBUTES)
        dest_dir = dest_dir / f'{file_name}.fcg'
        dgl.data.utils.save_graphs(str(dest_dir), [dg])
        print(f"Processed {source_file}")
    except:
        print(f"Error while processing {source_file}")
        traceback.print_exception(*sys.exc_info())
        return


if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Preprocess APK Dataset into Graphs')

    parser.add_argument(
        '-m', '--mode',
        help='This will auto take "train", "test", "custom" value',
        default='custom'
    )

    parser.add_argument(
        '-s', '--source-dir',
        help='The directory containing apks=',
    )

    parser.add_argument(
        '-d', '--dest-dir',
        help='The directory to store processed graphs',
    )

    parser.add_argument(
        '-np', '--no-prune',
        help="This flag will disable the pruning process",
        default=False
    )

    parser.add_argument(
        '--override',
        help='Override existing processed files',
        action='store_true'
    )
    parser.add_argument(
        '--dry',
        help='Run without actual processing',
        action='store_true'
    )
    parser.add_argument(
        '--limit',
        help='Run for n apks',
        default=-1
    )

    args = parser.parse_args()

    if args.mode == 'custom':
        source_dir = Path(args.source_dir)
        dest_dir = Path(args.dest_dir)
    elif args.mode == 'test':
        source_dir = Path("dataset/raw/test")
        dest_dir = Path("dataset/graph/test")
    elif args.mode == 'train':
        source_dir = Path("dataset/raw/train")
        dest_dir = Path("dataset/graph/train")
    else:
        raise ValueError(f'--mode="{args.mode}" not found')

    if not source_dir.exists():
        raise FileNotFoundError(f'{source_dir} not found')
    if not dest_dir.exists():
        raise FileNotFoundError(f'{dest_dir} not found')

    n_jobs = multiprocessing.cpu_count()

    if not args.no_prune:
        GraphPruning._get_pscout_api(
            'process_dataset/sensitive_apis/pscoutApi.txt')

    files = [x for x in source_dir.iterdir() if x.is_file()]
    source_files = set([x.stem for x in files])
    dest_files = set([x.name for x in dest_dir.iterdir() if x.is_file()])
    unprocessed = [source_dir / f'{x}.apk' for x in source_files - dest_files]
    print(
        f"Only {len(unprocessed)} out of {len(source_files)} remain to be processed")
    if args.override:
        print(
            f"--override specified. Ignoring {len(source_files) - len(unprocessed)} processed files")
        unprocessed = [source_dir / f'{x}.apk' for x in source_files]
    print(f"Starting dataset processing with {n_jobs} Jobs")
    limit = int(args.limit)
    if limit != -1:
        print(f"Limiting dataset processing to {limit} apks.")
        unprocessed = unprocessed[:limit]
    if not args.dry:
        J.Parallel(n_jobs=n_jobs)(J.delayed(process)(x, dest_dir)
                                  for x in unprocessed)
    print("DONE")
